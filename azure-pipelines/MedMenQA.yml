steps:
  - task: InstallAppleCertificate@2
    displayName: "Install an Apple certificate"
    inputs:
      certSecureFile: enterpriseVSTS_0925.p12
      certPwd: $(P12password)

  - task: InstallAppleProvisioningProfile@1
    displayName: "Install an Apple provisioning profile"
    inputs:
      provProfileSecureFile: InHouse_com.medmen.Medmen.ent.mobileprovision

  # - script: |
  #     bin/buildVersion $(System.DefaultWorkingDirectory) $(Build.BuildId)
  #   displayName: "Update Version to latest"

  # - script: |
  #     curl -sL https://sentry.io/get-cli/ | bash
  #   displayName: "Update Sentry cli"

  - task: Cache@2
    displayName: Cache
    inputs:
      key: 'cacheV2 | pods | "$(Agent.OS)" | Podfile | Podfile.lock'
      path: 'Pods'
      cacheHitVar: 'PODS_CACHE_RESTORED'

  - task: CocoaPods@0
    displayName: "pod install"
    condition: ne(variables.PODS_CACHE_RESTORED, 'true')
    inputs:
      forceRepoUpdate: false

  - script: |
      bundle install
    displayName: Bundle Install

  - script: |
      bundle exec fastlane medmenqa_enterprise_archive
    displayName: Archive IPA
    
  - task: CopyFiles@2
    displayName: "Copy Files"
    inputs:
      SourceFolder: $(System.DefaultWorkingDirectory)
      Contents: "build/MedMenQA.ipa"
      TargetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    displayName: "Publish Artifact: MedMenQA"
    inputs:
      PathtoPublish: $(Build.ArtifactStagingDirectory)
      ArtifactName: "MedMenQA"
